---
title: GEO-2
tags: 技术
author: ws
---
>～神威

<!--more-->

1、屈服了，还是GEOquery包方便
```
## 加载R包
library(GEOquery)
## 下载数据，如果文件夹中有会直接读入
gset = getGEO('GSE31718', destdir=".",getGPL = F)
## 获取ExpressionSet对象，包括的表达矩阵和分组信息
gset=gset[[1]]
```

2、 获取分组信息,点开查阅信息
```
pdata=pData(gset)


```
3、加载包
```
library(dplyr)
library(tibble)
library(tidyr)
```
4、获取表达数据

```
jdata=exprs(gset)
library(limma)
```
5、log转换
```
ex <- data
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm=T))
LogC <- (qx[5] > 100) ||
  (qx[6]-qx[1] > 50 && qx[2] > 0) ||
  (qx[2] > 0 && qx[2] < 1 && qx[4] > 1 && qx[4] < 2)
## 开始判断
if (LogC) {
  ex[which(ex <= 0)] <- NaN
  ## 取log2
  data <- log2(ex)
  print("log2 transform finished")
}else{
  print("log2 transform not needed")
}
```
6、标准化
```
boxplot(data,outline=FALSE, notch=T,las=2)
### 该函数默认使用quntile 矫正差异
data=normalizeBetweenArrays(data)
boxplot(data,outline=FALSE, notch=T, las=2)
## 这步把矩阵转换为数据框很重要
class(data)
data1 <- as.data.frame(data)
```
7、获取探针信息
```
GPL6254 <-getGEO('GPL6254',destdir =".")
GPL6254_anno <- Table(GPL6254)
GPL6254_anno <- GPL6254_anno %>%
  select(ID,GENE_SYMBOL)
```
7、探针转换
```
data1 <- data1 %>%
  rownames_to_column(var="ID") %>%
  #合并探针的信息
  inner_join(GPL6254_anno,by="ID") %>%
  #去掉多余信息
  select(-ID) %>%
  #重新排列
  select(GENE_SYMBOL,everything()) %>%
  #求出平均数(这边的点号代表上一步产出的数据)
  mutate(rowMean =rowMeans(.[,-1])) %>%
  #去除symbol中的NA
  filter(GENE_SYMBOL != "NA") %>%
  #把表达量的平均值按从大到小排序
  arrange(desc(rowMean)) %>%
  # symbol留下第一个
  distinct(GENE_SYMBOL,.keep_all = T) %>%
  #反向选择去除rowMean这一列
  select(-rowMean) %>%
  # 列名变成行名
  column_to_rownames(var = "GENE_SYMBOL")
```

8、数据里面有NA，一件去除NA
```
data2 <- select(data1,1,3,5,7,9,11,13,15,17,19,2,4,6,8,10,12,14,16,18,20)
library(IDPmisc)
data2 <- NaRV.omit(data2)
```
[【R】如何去掉数据框中包含非数值的行？写的太好了][1]

9、配对差异分析
```
data2 <- select(data1,1,3,5,7,9,11,13,15,17,19,2,4,6,8,10,12,14,16,18,20)
library(IDPmisc)
data2 <- NaRV.omit(data2)
#data2里面已经去掉NA值了
library(limma)
group <- c(rep('irritative',10),rep('epileptogenic',10))
group <- factor(group,levels = c("irritative","epileptogenic"),ordered = F)

#构建表达矩阵
pairinfo = factor(rep(1:10,2))
design <- model.matrix(~pairinfo+group)
## 比较矩阵命名
colnames(design) <- levels(group)
#线性模型拟合
fit <- lmFit(data2,design)
#贝叶斯检验
fit2 <- eBayes(fit)
#输出差异基因
allDiff=topTable(fit2,adjust='BH',coef=2,p.value=0.05,number=Inf)



library(pheatmap)
## 设定差异基因阈值，减少差异基因用于提取表达矩阵
allDiff_pair=topTable(fit2,adjust='BH',coef=2,number=Inf,p.value=0.05,lfc =0.5)
##提前部分数据用作热图绘制
heatdata <- data2[rownames(allDiff_pair),]
heatdata <- NaRV.omit(heatdata)
##制作一个分组信息用于注释
annotation_col <- data.frame(group)
rownames(annotation_col) <- colnames(heatdata)

#如果注释出界，可以通过调整格子比例和字体修正

pheatmap(heatdata, #热图的数据
         cluster_rows = T,#行聚类
         cluster_cols = F,#列聚类，可以看出样本之间的区分度
         annotation_col =annotation_col, #标注样本分类
         annotation_legend=TRUE, # 显示注释
         show_rownames = T,# 显示行名
         show_colnames = T,# 显示列名
         scale = "row", #以行来标准化，这个功能很不错
         color =colorRampPalette(c("blue", "white","red"))(100))
#火山图1
if (!requireNamespace('BiocManager', quietly = TRUE))
  install.packages('BiocManager')

BiocManager::install('EnhancedVolcano')
library(EnhancedVolcano)
colnames(data3)[1] <- 'log2FC'
EnhancedVolcano(data3,
                lab = rownames(data3),
                x = 'log2FC',
                y = 'P.Value')


#火山图

library(ggplot2)
library(ggrepel)
library(dplyr)

data3 <- topTable(fit2,adjust='BH',coef=2,number=Inf)
data3$significant <- as.factor(data3$adj.P.Val<0.05 & abs(data3$logFC) > 0.5)
data3$gene <- rownames(data3)
ggplot(data=data3, aes(x=logFC, y =-log10(adj.P.Val),color=significant)) +
  geom_point(alpha=0.8, size=1.2,col="black")+
  geom_point(data=subset(data3, logFC > 0.5),alpha=0.8, size=1.2,col="red")+
  geom_point(data=subset(data3, logFC < -0.5),alpha=0.6, size=1.2,col="blue")+
  labs(x="log2 (fold change)",y="-log10 (adj.P.Val)")+
  theme(plot.title = element_text(hjust = 0.4))+
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+
  geom_vline(xintercept = c(0.5,-0.5),lty=4,lwd=0.6,alpha=0.8)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),   
        axis.line = element_line(colour = "black")) +
  geom_point(data=subset(data3, abs(logFC) > 1),alpha=0.8, size=3,col="green")+
  geom_text_repel(data=subset(data3, abs(logFC) > 1),
                  aes(label=gene),col="black",alpha = 0.8)

## 加载R包
suppressMessages(library(clusterProfiler))
#获得基因列表
gene <- rownames(allDiff)
#基因名称转换，返回的是数据框
gene = bitr(gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
de <- gene$ENTREZID
## GO分析
go <- enrichGO(gene = de, OrgDb = "org.Hs.eg.db", ont="all")
library(ggplot2)
p <- dotplot(go, split="ONTOLOGY") +facet_grid(ONTOLOGY~., scale="free")
p
EGG <- enrichKEGG(gene= gene$ENTREZID,
                  organism     = 'hsa',
                  pvalueCutoff = 0.05)
dotplot(EGG)
test <- data.frame(EGG)
browseKEGG(EGG, 'hsa00601')
library(ggplot2)
library(ggrepel)
library(dplyr)

data3 <- allDiff_pair
van = ggplot(data3,aes(logFC,-log10(FDR)))
van + geom_point(aes(color =significant))


data3$significant <- as.factor(data3$adj.P.Val<0.05 & abs(data3$logFC) > 2)
data3$gene <- rownames(data3)
class(data3)
ggplot(data=data3, aes(x=logFC, y =-log10(adj.P.Val),color=significant)) +
  geom_point(alpha=0.8, size=1.2,col="black")+
  geom_point(data=subset(data3, logFC > 2),alpha=0.8, size=1.2,col="red")+
  geom_point(data=subset(data3, logFC < -2),alpha=0.6, size=1.2,col="blue")+
  labs(x="log2 (fold change)",y="-log10 (adj.P.Val)")+
  theme(plot.title = element_text(hjust = 0.4))+
  geom_hline(yintercept = -log10(0.05),lty=4,lwd=0.6,alpha=0.8)+
  geom_vline(xintercept = c(0.5,-0.5),lty=4,lwd=0.6,alpha=0.8)+
  theme_bw()+
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),   
        axis.line = element_line(colour = "black")) +
  geom_point(data=subset(data3, abs(logFC) > 2),alpha=0.8, size=3,col="green")+
  geom_text_repel(data=subset(data3, abs(logFC) > 2),
                  aes(label=gene),col="black",alpha = 0.8)


design <- model.matrix(~group)
fit <- lmFit(exprSet,design)
fit2 <- eBayes(fit)
```
[1]:https://www.cnblogs.com/jessepeng/p/12581180.html#4-%E6%80%BB%E7%BB%93%E4%B8%8B%E6%8E%A8%E8%8D%90%E7%94%A8%E6%B3%95
